## 内存分配

info memory 查看

 - 进程自身占用内存
 - 数据占用内存
 - 客户端缓冲区（TCP输入输出缓冲区、复制积压缓冲区、AOF重写缓冲区）
 - 内存碎片
 - 子进程内存消耗（重写AOF或RDB保存）

### 复制积压缓冲区

复制积压缓冲区是为了 slave断线重连时避免全量同步而引入的。为了避免全量同步，需要：

- 判断master节点是否相同，每个slave带有主节点的runid
- 要知道从哪里开始增量同步：slave、master双方需要分别维护命令同步的offset。

复制挤压缓冲区就是维护历史命令的一块定长内存。

### AOF重写缓冲区与AOF缓冲区

AOF缓冲区是缓存执行的历史命令，然后通过定时任务刷入到AOF文件

AOF重写是为了压缩AOF文件，AOF重写缓冲区是在子进程重写AOF时执行的命令。待子进程重写AOF之后，会到主进程**阻塞**的将命令写入AOF中。

### 内存使用细节

为了提升数据的访问效率，redis以空间换时间的策略很常见：比如在槽点记录时，不仅在每个clusterNode中记录了某个node负责的槽点，在clusterState中记录了key为槽id，值为负责槽点的冗余信息。